# Category Traversal System

The category traversal system is responsible for handling routing the user through the category diagnosis questions.

## Overview

The category traversal system is designed to
- Handle multi-step questionnaires with branching logic
- Pre-calculate all possible navigation paths
- Support both internal and external redirects
- Provide a mapping of the users answers to each question
- Provide back links remembering the users previous answer

Whilst keeping the service stateless and without requiring session data to be stored by the user.

This system implements a [Mealy Finite State Machine](https://en.wikipedia.org/wiki/Mealy_machine), where the next state
is only a function of the current state and an input.

If business requirements require the next state to be a function of the users previous answers then this can be achieved
by splitting the path and having two parallel routes depending on the users previous answer.

## How to add a question
To add new question

1. Create a new question form class inheriting from `QuestionForm`:

    Each question form must define:
   - `category`: The category of law the question belongs to
   - `title`: The question text populating the page title
   - `question`: A WTForms form field containing the actual question
   - `routing_logic`: A dictionary mapping answer choices to their next steps

Example:
```python
class MyQuestionForm(QuestionForm):
    title = "What type of help do you need?"
    
    routing_logic = {
        "yes": NextQuestionForm,  # Question forms should only be initalised when handling the users request.
        "no": "internal.endpoint"
    }
    
    question = RadioField(
        title,
        widget=CategoryRadioInput(),  # Uses our override class to support setting custom CSS on the label title
        validators=[InputRequired(message="Validation failed message")],
        choices=[
            ("yes", "Yes"),
            ("no", "No"),
        ],
    )
```

2. Add your new question form to the routing logic of an existing question:
```python
class ExistingQuestionForm(QuestionForm):
    routing_logic = {
        "existing-choice": ExistingNextStep,
        "new-choice": NewQuestionForm  # Add your new form here
    }
```

## Testing New Questions

1. Add your new question forms
2. Initialize the traversal system
3. Verify all paths using `get_all_valid_paths()`
4. Test navigation through each possible path
5. Verify back-button functionality works correctly

### Routing Options

You can route to:
1. Another question form: `"choice": NextQuestionForm`
2. Internal endpoint: `"choice": "endpoint.name"`
3. External URL: `"choice": redirect("https://example.com")`

### Requirements for questions

1. **Choice Keys**
   - Use kebab-case for choice keys (e.g., "my-choice")
   - Keep keys descriptive but concise
   - Ensure keys are URL-safe

2. **Routing Logic**
   - Ensure all paths eventually lead to an endpoint
   - Avoid circular references
   - The next page logic must only be a function of the users answer to the current question.

## Question Answer Map
The question answer map is generated by `CategoryTraversal.get_question_answer_map`.

This is a function of a URL path and is a dictionary of the users answers to the questions they have been presented with.

As this is intended to be passed to the Call Handling System the human-readable English labels are used 
to represent both the question and answer.

Example question answer map:
```python
{
    'Choose the problem you need help with': 'Discrimination', 
    'Where did the discrimination happen?': 'Work - including colleagues, employer or employment agency',
    'Why were you treated differently?': 'Disability, health condition, mental health condition'
}
```

## Technical Details

### NavigationResult
Represents the outcome of navigating to a specific path:
- `question_form`: Next question to display
- `internal_redirect`: Flask endpoint to redirect to
- `external_redirect`: External URL to redirect to

The outcome is handled by the `question_page` route in `categories/routes.py`.

### Path Format
Paths are constructed by joining choice keys with forward slashes:
- Empty path `""` represents the initial question
- Each subsequent choice adds to the path: `"choice1/choice2/choice3"`

## Error Handling

When `CategoryTraversal.navigate_path` is called with an invalid path a werkzeug NotFound exception is raised.
This is handled by the `question_page` route.

When evaluating a Question Answer Map if an invalid response is found the map will append `invalid choice` to the relevant question
and stop evaluating the path any further.
