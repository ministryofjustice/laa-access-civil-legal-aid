name: Build documentation

on:
  workflow_call:
    outputs:
      artifact-name:
        description: "GitHub Pages deployment artifact identifier"
        value: github-pages
      success:
        description: "Whether the build completed successfully"
        value: ${{ jobs.build.outputs.success }}

permissions:
  contents: read

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/ministryofjustice/tech-docs-github-pages-publisher@sha256:30d00879b5c82afa5d76264164db46189fa11d4358b37ca35b6a62e341d62bb7 # v5.1.0
    steps:
      # We only checkout the docs directory, which allows us to keep all necessary files for
      # generating the docs separate from the app.
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          sparse-checkout: |
            docs
          sparse-checkout-cone-mode: false

      # We move the docs directory to the root so it is treated as if the docs directory was
      # the only thing in the repository.
      - name: Move directory to root
        run: |
          mv docs/* .
          rm -rf docs

      - name: Compile Markdown to HTML and create artifact
        run: |
          /usr/local/bin/package

      - name: Upload artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: github-pages
          path: artifact.tar
          retention-days: 1
          overwrite: true
